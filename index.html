<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz Practice</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
    }
    .question {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .question h3 {
      margin-top: 0;
    }
    .result {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Quiz Practice</h1>
  <label for="gradeSelect">選擇年級：</label>
  <select id="gradeSelect">
    <option value="all">全部</option>
  </select>

  <label for="topicSelect">選擇主類別：</label>
  <select id="topicSelect">
    <option value="all">全部</option>
  </select>

  <div id="quiz"></div>

  <script>
    let allQuestions = [];

    fetch("https://script.google.com/macros/s/AKfycbzFQiGir8ljmy2T4fXC3did8xX0oB3o5LkcfJljEOixUGVjm7o50hialhKF8sCuSho0Tg/exec")
      .then((res) => res.json())
      .then((questions) => {
        allQuestions = questions;

        const gradeSelect = document.getElementById("gradeSelect");
        const topicSelect = document.getElementById("topicSelect");
        const quizContainer = document.getElementById("quiz");

        // 抽出所有年級並加入選單
        const grades = [...new Set(questions.map(q => q["年級"]))];
        grades.forEach(grade => {
          const option = document.createElement("option");
          option.value = grade;
          option.textContent = grade;
          gradeSelect.appendChild(option);
        });

        // 根據年級產生對應主類別
        function updateTopicsByGrade(selectedGrade) {
          topicSelect.innerHTML = '<option value="all">全部</option>';
          const filteredByGrade = selectedGrade === "all"
            ? questions
            : questions.filter(q => q["年級"] === selectedGrade);
          const topics = [...new Set(filteredByGrade.map(q => q["主類別"]))];
          topics.forEach(topic => {
            const option = document.createElement("option");
            option.value = topic;
            option.textContent = topic;
            topicSelect.appendChild(option);
          });
        }

        // 顯示題目
        function renderQuestions(selectedGrade, selectedTopic) {
          quizContainer.innerHTML = "";

          const filtered = allQuestions.filter(q => {
            const matchGrade = selectedGrade === "all" || q["年級"] === selectedGrade;
            const matchTopic = selectedTopic === "all" || q["主類別"] === selectedTopic;
            return matchGrade && matchTopic;
          });

          filtered.forEach((q, index) => {
            const container = document.createElement("div");
            container.className = "question";

            const title = document.createElement("h3");
            title.textContent = `${index + 1}. ${q["題目內容"]}`;
            container.appendChild(title);

            ["A", "B", "C", "D"].forEach((opt) => {
              const optionText = q[`選項 ${opt}`] || q[opt];
              if (optionText) {
                const label = document.createElement("label");
                label.innerHTML = `<input type="radio" name="q${index}" value="${opt}"> ${optionText}`;
                container.appendChild(label);
                container.appendChild(document.createElement("br"));
              }
            });

            const result = document.createElement("div");
            result.className = "result";
            container.appendChild(result);

            container.addEventListener("change", (e) => {
              const selected = e.target.value;
              const correct = q["答案"];
              const answerText = q[`選項 ${correct}`] || q[correct];
              if (selected === correct) {
                result.textContent = "✅ 正確！";
                result.style.color = "green";
              } else {
                result.textContent = `❌ 錯了，正確答案是 ${correct}: ${answerText}`;
                result.style.color = "red";
              }
            });

            quizContainer.appendChild(container);
          });
        }

        // 預設載入
        updateTopicsByGrade("all");
        renderQuestions("all", "all");

        // 事件監聽
        gradeSelect.addEventListener("change", () => {
          const selectedGrade = gradeSelect.value;
          updateTopicsByGrade(selectedGrade);
          renderQuestions(selectedGrade, topicSelect.value);
        });

        topicSelect.addEventListener("change", () => {
          renderQuestions(gradeSelect.value, topicSelect.value);
        });
      })
      .catch((err) => console.error("載入 JSON 失敗:", err));
  </script>
</body>
</html>

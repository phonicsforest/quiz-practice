<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz Practice</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      font-size: 25px;
    }
    select, label, option {
      font-size: 25px;
    }
    input[type="text"], textarea {
      font-size: 25px;
    }
    .question {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .question h3 { margin-bottom: 8px; }
    .question p { line-height: 2; }
    button {
      margin-top: 10px;
      padding: 5px 10px;
      font-weight: bold;
    }
    .underline-input {
      border: none;
      border-bottom: 2px solid black;
      outline: none;
      width: 120px;
      margin: 0 5px;
    }
    .comprehension-container {
      display: flex;
      gap: 20px;
      align-items: stretch;
    }
    .comprehension-passage {
      flex: 3;
      border: 1px solid #ccc;
      padding: 15px;
      line-height: 1.3;
      overflow-y: auto;
    }
    .comprehension-questions {
      flex: 2;
      border: 1px solid #ccc;
      padding: 15px;
      overflow-y: auto;
      max-height: 800px;
    }
    .img-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .img-box {
      text-align: center;
    }
    .img-box img {
      max-width: 150px;
      display: block;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>Quiz Practice</h1>
  <label for="gradeSelect">Grade：</label>
  <select id="gradeSelect"><option value="all">all</option></select>
  <label for="termSelect">Term：</label>
  <select id="termSelect"><option value="all">all</option></select>
  <label for="topicSelect">Topic：</label>
  <select id="topicSelect"><option value="all">all</option></select>
  <div id="quiz"></div>

  <script>
    let allQuestions = [];
    fetch("https://script.google.com/macros/s/AKfycbzFQiGir8ljmy2T4fXC3did8xX0oB3o5LkcfJljEOixUGVjm7o50hialhKF8sCuSho0Tg/exec")
      .then(res => res.json())
      .then(questions => {
        allQuestions = questions;
        const quizContainer = document.getElementById("quiz");
        const gradeSelect = document.getElementById("gradeSelect");
        const topicSelect = document.getElementById("topicSelect");
        const termSelect = document.getElementById("termSelect");

        const setOptions = (selectEl, values) => {
          const unique = [...new Set(values)];
          unique.forEach(val => {
            const option = document.createElement("option");
            option.value = val;
            option.textContent = val;
            selectEl.appendChild(option);
          });
        };

        setOptions(gradeSelect, questions.map(q => q["Grade"]));
        setOptions(topicSelect, questions.map(q => q["Topic"]));
        setOptions(termSelect, questions.map(q => q["Term"]));

        function renderQuestions() {
          const selectedGrade = gradeSelect.value;
          const selectedTopic = topicSelect.value;
          const selectedTerm = termSelect.value;

          const filtered = allQuestions.filter(q => {
            const matchGrade = selectedGrade === "all" || q["Grade"] === selectedGrade;
            const matchTopic = selectedTopic === "all" || q["Topic"] === selectedTopic;
            const matchTerm = selectedTerm === "all" || q["Term"] === selectedTerm;
            return matchGrade && matchTopic && matchTerm;
          });

          quizContainer.innerHTML = "";

          filtered.forEach((q, index) => {
            const container = document.createElement("div");
            container.className = "question";
            const title = document.createElement("h3");
            title.textContent = `${index + 1}. ${q["instruction"] || "Question"}`;
            container.appendChild(title);

            try {
              const type = q["Type"];
              const question = q["question"];
              const answer = q["answer"];

              if (type === "match-image") {
                const p = document.createElement("p");
                p.textContent = question;
                container.appendChild(p);
                const imageWrapper = document.createElement("div");
                imageWrapper.className = "img-row";
                const images = JSON.parse(q["imageSet"] || "[]");
                images.forEach((url, i) => {
                  const box = document.createElement("div");
                  box.className = "img-box";
                  const img = document.createElement("img");
                  img.src = url;
                  const input = document.createElement("input");
                  input.type = "text";
                  input.placeholder = `Image ${i + 1}`;
                  box.appendChild(img);
                  box.appendChild(input);
                  imageWrapper.appendChild(box);
                });
                container.appendChild(imageWrapper);
              }
              else if (type === "comprehension") {
                const parsed = JSON.parse(question);
                const compWrap = document.createElement("div");
                compWrap.className = "comprehension-container";

                const passage = document.createElement("div");
                passage.className = "comprehension-passage";
                passage.innerHTML = `<p>${parsed.text.replace(/\n/g, "<br>")}</p>`;
                compWrap.appendChild(passage);

                const qBlock = document.createElement("div");
                qBlock.className = "comprehension-questions";

                const answerList = JSON.parse(answer || "[]");
                const imageSet = JSON.parse(q["imageSet"] || "[]");

                parsed.questions.forEach((item, idx) => {
                  const wrap = document.createElement("div");
                  const num = idx + 1;
                  const type = item.type || "text";

                  if (type === "match-image") {
                    const p = document.createElement("p");
                    p.textContent = `${num}. ${item.text}`;
                    wrap.appendChild(p);
                    const imageWrapper = document.createElement("div");
                    imageWrapper.className = "img-row";
                    imageSet.forEach((url, i) => {
                      const box = document.createElement("div");
                      box.className = "img-box";
                      const img = document.createElement("img");
                      img.src = url;
                      const input = document.createElement("input");
                      input.type = "text";
                      input.placeholder = `Image ${i + 1}`;
                      box.appendChild(img);
                      box.appendChild(input);
                      imageWrapper.appendChild(box);
                    });
                    wrap.appendChild(imageWrapper);
                  }
                  qBlock.appendChild(wrap);
                });
                compWrap.appendChild(qBlock);
                container.appendChild(compWrap);
              }
            } catch (err) {
              console.warn("❌ 題目處理失敗：", q["Q number"], err);
            }

            const submitBtn = document.createElement("button");
            submitBtn.textContent = "Submit";
            container.appendChild(submitBtn);
            quizContainer.appendChild(container);
          });
        }

        renderQuestions();
        gradeSelect.addEventListener("change", renderQuestions);
        topicSelect.addEventListener("change", renderQuestions);
        termSelect.addEventListener("change", renderQuestions);
      })
      .catch(err => console.error("載入 JSON 失敗:", err));
  </script>
</body>
</html>
